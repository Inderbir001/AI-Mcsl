<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QA Issue Tracker Chatbot</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg,#07102a 0%, #081226 100%); color: #e6eef6; }
    .scrollbar-thin::-webkit-scrollbar { width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-6xl bg-slate-900/70 rounded-2xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-teal-400 to-indigo-500 flex items-center justify-center text-slate-900 font-bold">QA</div>
        <div>
          <div class="text-lg font-semibold">QA Tracker Bot</div>
          <div class="text-sm text-slate-400">Send issues, detect duplicates, view saved issues — connected via WebSocket</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="fetchIssuesBtn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium shadow">Request saved issues</button>
        <div id="status" class="flex items-center gap-2 text-sm">
          <span id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></span>
          <span id="status-text">Connecting...</span>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-6 p-6">
      <section class="flex flex-col gap-4">
        <div id="chat-log" class="flex-1 min-h-[48vh] max-h-[60vh] overflow-y-auto scrollbar-thin p-4 bg-slate-900 rounded-xl border border-slate-800">
        </div>

        <form id="message-form" class="flex gap-3">
          <input id="message-input" type="text" placeholder="Enter issue or chat. Examples: '- App crashes on upload' or 'Inder, remember this: I like mangoes' " class="flex-1 rounded-lg p-3 bg-slate-800 border border-slate-700 text-white focus:outline-none" />
          <button type="submit" class="px-5 py-3 rounded-lg bg-emerald-500 hover:bg-emerald-600 font-semibold text-slate-900">Send</button>
          <button type="button" id="clearBtn" class="px-4 py-3 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600">Clear</button>
        </form>

        <div class="text-xs text-slate-400 italic">Tip: use "Inder, remember this:" to save a permanent fact. Use "clear issues" to reset issues on server.</div>
      </section>

      <aside class="flex flex-col bg-slate-900 rounded-xl p-4 border border-slate-800">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-semibold">Saved issues</div>
          <div class="text-xs text-slate-400" id="issuesCount">0</div>
        </div>

        <div id="issuesList" class="flex-1 overflow-y-auto scrollbar-thin space-y-3 px-1 pb-2">
          <div class="text-sm text-slate-400">No saved issues yet.</div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="clearIssuesBtn" class="flex-1 px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">Clear server issues</button>
          <button id="downloadBtn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white">Download JSON</button>
        </div>

        <pre id="rawDump" class="mt-3 text-xs text-slate-400 mono p-2 bg-slate-800 rounded-md max-h-40 overflow-auto"></pre>
      </aside>
    </div>
  </div>

<script>
const wsUrl = 'ws://127.0.0.1:8080';
  let latestIssues = [];

  const chatLog = document.getElementById('chat-log');
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');
  const fetchIssuesBtn = document.getElementById('fetchIssuesBtn');
  const issuesList = document.getElementById('issuesList');
  const issuesCount = document.getElementById('issuesCount');
  const clearIssuesBtn = document.getElementById('clearIssuesBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const rawDump = document.getElementById('rawDump');
  const clearBtn = document.getElementById('clearBtn');

  function setStatus(s) {
    if (s === 'connecting') {
      statusDot.className = 'w-3 h-3 rounded-full bg-yellow-400 animate-pulse';
      statusText.textContent = 'Connecting...';
    } else if (s === 'connected') {
      statusDot.className = 'w-3 h-3 rounded-full bg-green-400';
      statusText.textContent = 'Connected';
    } else {
      statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
      statusText.textContent = 'Disconnected';
    }
  }

  function appendBubble(text, who='bot') {
    const wrapper = document.createElement('div');
    wrapper.className = who === 'user' ? 'flex justify-end' : 'flex justify-start';
    const bubble = document.createElement('div');
    bubble.className = 'p-3 rounded-lg max-w-[85%]';
    if (who === 'user') bubble.classList.add('bg-emerald-500','text-slate-900','rounded-br-none');
    else if (who === 'error') bubble.classList.add('bg-red-700','text-white','italic');
    else bubble.classList.add('bg-slate-800','text-slate-200','rounded-tl-none');
    bubble.innerHTML = escapeHtml(text);
    wrapper.appendChild(bubble);
    chatLog.appendChild(wrapper);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

  function connect(){
    setStatus('connecting');
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      setStatus('connected');
      appendBubble('QA Assistant: Ready. Submit issues or chat with Inder.', 'bot');
    };

    ws.onmessage = (ev) => {
      try {
        const payload = JSON.parse(ev.data);
        if (payload.type === 'bot') {
          // payload.text may be a JSON stringified object (structured response)
          try {
            const parsed = JSON.parse(payload.text);
            // If structured response from issue handler
            if (parsed && (parsed.summary || parsed.newIssues || parsed.existingMatches)) {
              const s = parsed.summary || {};
              appendBubble(`Handled issues — New: ${s.newCount||0}, Existing: ${s.existingCount||0}`, 'bot');
              if (parsed.newIssues?.length) parsed.newIssues.forEach(n => appendBubble(`New: ${n.title} (id: ${n.id})`, 'bot'));
              if (parsed.existingMatches?.length) parsed.existingMatches.forEach(m => appendBubble(`Existing match: ${m.matchTitle} (similarity: ${m.similarity})`, 'bot'));
              // request fresh dump
              ws.send('__dump_issues__');
              return;
            }
            // special dump cmd response
            if (parsed && parsed.cmd === 'dump_issues' && Array.isArray(parsed.issues)) {
              latestIssues = parsed.issues;
              renderIssues(latestIssues);
              rawDump.textContent = JSON.stringify(parsed.issues, null, 2);
              appendBubble('Saved issues updated in panel.', 'bot');
              return;
            }
          } catch (e) {
            // not structured JSON
          }
          appendBubble(payload.text, 'bot');
        } else if (payload.type === 'error') {
          appendBubble(payload.text, 'error');
        } else {
          appendBubble(JSON.stringify(payload), 'bot');
        }
      } catch (e) {
        appendBubble(ev.data, 'bot');
      }
    };

    ws.onerror = (err) => { console.error('WS error', err); setStatus('disconnected'); };
    ws.onclose = () => { setStatus('disconnected'); appendBubble('Connection closed. Reconnecting...', 'error'); setTimeout(connect, 3000); };
  }

  function renderIssues(list){
    issuesList.innerHTML = '';
    if (!list || list.length === 0) {
      issuesList.innerHTML = '<div class="text-sm text-slate-400">No saved issues.</div>';
      issuesCount.textContent = '0';
      rawDump.textContent = '';
      return;
    }
    issuesCount.textContent = String(list.length);
    list.forEach(issue => {
      const node = document.createElement('div');
      node.className = 'p-3 rounded-lg bg-slate-800 border border-slate-700';
      node.innerHTML = `<div class="font-semibold">${escapeHtml(issue.title)}</div>
                        <div class="text-xs text-slate-400 mt-1">${escapeHtml(issue.raw)}</div>
                        <div class="text-xs text-slate-400 mt-2">id: <span class="mono">${issue.id}</span> • created: ${new Date(issue.createdAt).toLocaleString()}</div>`;
      issuesList.appendChild(node);
    });
  }

  messageForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = messageInput.value.trim();
    if (!msg) return;
    if (ws && ws.readyState === WebSocket.OPEN) {
      appendBubble(msg, 'user');
      ws.send(msg);
      messageInput.value = '';
    } else {
      appendBubble('Not connected. Waiting to reconnect...', 'error');
    }
  });

  fetchIssuesBtn.addEventListener('click', () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send('__dump_issues__');
    } else appendBubble('Not connected.', 'error');
  });

  clearIssuesBtn.addEventListener('click', () => {
    if (!confirm('Clear all saved issues on the server?')) return;
    if (ws && ws.readyState === WebSocket.OPEN) ws.send('clear issues');
  });

  downloadBtn.addEventListener('click', () => {
    const data = JSON.stringify(latestIssues, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'issues.json'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  clearBtn.addEventListener('click', () => messageInput.value = '');

  // start
  connect();
</script>
</body>
</html>
